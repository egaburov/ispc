PROG=mandel_cu
ISPC_SRC=mandelbrot_tasks3d.ispc
CXX_SRC=mandel_cu.cpp  mandelbrot_tasks_serial.cpp

CXX=g++
CXXFLAGS=-O3 -I$(CUDATK)/include
LD=g++
LDFLAGS=-lcuda

ISPC=ispc
ISPCFLAGS=-O3 --math-lib=default --target=nvptx64 --opt=fast-math

LLVM32 = $(HOME)/usr/local/llvm/bin-3.2
LLVM   = $(HOME)/usr/local/llvm/bin-3.3
PTXGEN = $(HOME)/ptxgen
PTXGEN += -opt=3
PTXGEN += -ftz=1 -prec-div=0 -prec-sqrt=0 -fma=1

LLVM32DIS=$(LLVM32)/bin/llvm-dis

.SUFFIXES: .bc .o .ptx .cu _ispc_nvptx64.bc


ISPC_OBJ=$(ISPC_SRC:%.ispc=%_ispc.o)
ISPC_BC=$(ISPC_SRC:%.ispc=%_ispc_nvptx64.bc)
PTXSRC=$(ISPC_SRC:%.ispc=%_ispc_nvptx64.ptx)
CXX_OBJ=$(CXX_SRC:%.cpp=%.o)

all: $(ISPC_BC) $(PROG)

CUDART:
	cd _cuobj && make
	g++ -o  mandel_cu_nvcc mandel_cu.cpp  -I$(CUDATK)/include  -lcuda mandelbrot_tasks_serial.cpp -L./_cuobj -lmandel_cudart -lcudart -L$(CUDATK)/lib64  -D_CUDART_ -lcudadevrt


$(CXX_OBJ) : kernel.ptx
$(PROG): $(CXX_OBJ) kernel.ptx
	/bin/cp kernel.ptx __kernels.ptx
	$(LD) -o $@ $(CXX_OBJ) $(LDFLAGS)

%.o: %.cpp
	$(CXX) $(CXXFLAGS)  -o $@ -c $<


%_ispc_nvptx64.bc: %.ispc
	$(ISPC) $(ISPCFLAGS) --emit-llvm -o `basename $< .ispc`_ispc_nvptx64.bc -h `basename $< .ispc`_ispc.h $< --emit-llvm

%.ptx: %.bc
	$(LLVM32DIS) $<
	$(PTXGEN)  `basename $< .bc`.ll > $@

kernel.ptx: $(PTXSRC)
	cat $^ > kernel.ptx

clean: 
	/bin/rm -rf *.ptx *.bc *.ll $(PROG)

	 

